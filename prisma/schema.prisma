generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String           @id @default(cuid())
  email           String           @unique
  password        String
  firstName       String
  lastName        String
  phoneNumber     String?
  role            UserRole
  isEmailVerified Boolean          @default(false)
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bookingGroups   BookingGroup[]
  bookings        Booking[]
  notifications   Notification[]
  operatorProfile OperatorProfile?
  otpTokens       OtpToken[]

  @@map("users")
}

model OperatorProfile {
  id                     String                 @id @default(cuid())
  userId                 String                 @unique
  companyName            String
  registrationNumber     String
  vatNumber              String?
  reputationScore        Decimal                @default(5.0) @db.Decimal(3, 2)
  totalJobs              Int                    @default(0)
  completedJobs          Int                    @default(0)
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  approvalStatus         OperatorApprovalStatus @default(PENDING)
  bankAccountName        String?
  bankAccountNumber      String?
  bankSortCode           String?
  businessAddress        String?
  businessPostcode       String?
  councilRegistration    String?
  emergencyContactName   String?
  emergencyContactPhone  String?
  fleetSize              Int?
  operatingLicenseNumber String?
  vehicleTypes           VehicleType[]
  bids                   Bid[]
  documents              Document[]
  drivers                Driver[]
  assignedJobs           Job[]                  @relation("AssignedOperator")
  user                   User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceAreas           ServiceArea[]
  vehicles               Vehicle[]

  @@index([approvalStatus])
  @@index([userId])
  @@map("operator_profiles")
}

model Vehicle {
  id                    String          @id @default(cuid())
  operatorId            String
  vehicleType           VehicleType
  registrationPlate     String
  make                  String
  model                 String
  year                  Int
  color                 String?
  logbookUrl            String?
  motCertificateUrl     String?
  motExpiryDate         DateTime?
  insuranceDocumentUrl  String?
  insuranceExpiryDate   DateTime?
  hirePermissionLetterUrl String?
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  operator              OperatorProfile @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  photos                VehiclePhoto[]
  driver                Driver?
  assignedJobs          Job[]           @relation("AssignedVehicle")

  @@map("vehicles")
}

enum VehiclePhotoType {
  FRONT
  BACK
  DRIVER_SIDE
  FRONT_SIDE
  DASHBOARD
  REAR_BOOT
}

model VehiclePhoto {
  id        String           @id @default(cuid())
  vehicleId String
  photoType VehiclePhotoType
  photoUrl  String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  vehicle   Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([vehicleId, photoType])
  @@map("vehicle_photos")
}

model Driver {
  id                      String          @id @default(cuid())
  operatorId              String
  firstName               String
  lastName                String
  email                   String?
  phoneNumber             String
  profileImageUrl         String?
  dateOfBirth             DateTime?
  passportUrl             String?
  passportExpiry          DateTime?
  drivingLicenseNumber    String?
  drivingLicenseFrontUrl  String?
  drivingLicenseBackUrl   String?
  drivingLicenseExpiry    DateTime?
  nationalInsuranceNo     String?
  nationalInsuranceDocUrl String?
  taxiCertificationUrl    String?
  taxiCertificationExpiry DateTime?
  taxiBadgePhotoUrl       String?
  taxiBadgeExpiry         DateTime?
  phvLicenseNumber        String?
  phvLicenseExpiry        DateTime?
  issuingCouncil          String?
  badgeNumber             String?
  vehicleId               String?         @unique
  isActive                Boolean         @default(true)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  operator                OperatorProfile @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  vehicle                 Vehicle?        @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  assignedJobs            Job[]           @relation("AssignedDriver")

  @@map("drivers")
}

model ServiceArea {
  id         String          @id @default(cuid())
  operatorId String
  postcode   String
  createdAt  DateTime        @default(now())
  operator   OperatorProfile @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@map("service_areas")
}

model Document {
  id           String          @id @default(cuid())
  operatorId   String
  documentType DocumentType
  fileUrl      String
  fileName     String
  uploadedAt   DateTime        @default(now())
  expiresAt    DateTime?
  operator     OperatorProfile @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model CancellationPolicy {
  id                String   @id @default(cuid())
  name              String
  hoursBeforePickup Int      @unique
  refundPercent     Int
  description       String?
  sortOrder         Int      @default(0)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("cancellation_policies")
}

model BookingGroup {
  id             String             @id @default(cuid())
  groupReference String             @unique
  customerId     String
  totalPrice     Decimal            @db.Decimal(10, 2)
  discountType   DiscountType?
  discountAmount Decimal?           @db.Decimal(10, 2)
  status         BookingGroupStatus @default(ACTIVE)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  customer       User               @relation(fields: [customerId], references: [id], onDelete: Cascade)
  bookings       Booking[]

  @@map("booking_groups")
}

model Booking {
  id                  String        @id @default(cuid())
  customerId          String
  bookingReference    String        @unique
  pickupAddress       String
  pickupPostcode      String?
  pickupLat           Decimal       @db.Decimal(10, 8)
  pickupLng           Decimal       @db.Decimal(11, 8)
  dropoffAddress      String
  dropoffPostcode     String?
  dropoffLat          Decimal       @db.Decimal(10, 8)
  dropoffLng          Decimal       @db.Decimal(11, 8)
  pickupDatetime      DateTime
  passengerCount      Int
  luggageCount        Int
  vehicleType         VehicleType
  serviceType         ServiceType
  flightNumber        String?
  specialRequirements String?
  customerPrice       Decimal       @db.Decimal(10, 2)
  status              BookingStatus @default(PENDING_PAYMENT)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  bookingGroupId      String?
  journeyType         JourneyType   @default(ONE_WAY)
  linkedBookingId     String?       @unique
  amendedAt           DateTime?
  amendmentFee        Decimal?      @db.Decimal(10, 2)
  boosterSeats        Int           @default(0)
  cancellationReason  String?
  cancelledAt         DateTime?
  childSeats          Int           @default(0)
  customerEmail       String?
  customerName        String?
  customerPhone       String?
  distanceMiles       Decimal?      @db.Decimal(10, 2)
  driverArrivedAt     DateTime?
  durationMinutes     Int?
  hasMeetAndGreet     Boolean       @default(false)
  markedNoShowAt      DateTime?
  noShowCharges       Decimal?      @db.Decimal(10, 2)
  originalPrice       Decimal?      @db.Decimal(10, 2)
  passengerPickedUpAt DateTime?
  refundAmount        Decimal?      @db.Decimal(10, 2)
  refundPercent       Int?
  terminal            String?
  waitingCharges      Decimal?      @db.Decimal(10, 2)
  bookingGroup        BookingGroup? @relation(fields: [bookingGroupId], references: [id])
  customer            User          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  linkedBooking       Booking?      @relation("LinkedBookings", fields: [linkedBookingId], references: [id])
  pairedBooking       Booking?      @relation("LinkedBookings")
  job                 Job?
  stops               BookingStop[]
  transactions        Transaction[]

  @@index([customerId])
  @@index([status])
  @@index([pickupDatetime])
  @@index([bookingGroupId])
  @@map("bookings")
}

model BookingStop {
  id        String   @id @default(cuid())
  bookingId String
  stopOrder Int
  address   String
  postcode  String?
  lat       Decimal  @db.Decimal(10, 8)
  lng       Decimal  @db.Decimal(11, 8)
  notes     String?
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@map("booking_stops")
}

model Job {
  id                         String           @id @default(cuid())
  bookingId                  String           @unique
  status                     JobStatus        @default(OPEN_FOR_BIDDING)
  biddingWindowClosesAt      DateTime
  assignedOperatorId         String?
  assignedDriverId           String?
  assignedVehicleId          String?
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  acceptanceAttemptCount     Int              @default(0)
  acceptanceWindowClosesAt   DateTime?
  acceptanceWindowOpensAt    DateTime?
  biddingWindowDurationHours Int              @default(24)
  biddingWindowOpensAt       DateTime         @default(now())
  completedAt                DateTime?
  currentOfferedBidId        String?
  payoutEligibleAt           DateTime?
  payoutProcessedAt          DateTime?
  payoutStatus               PayoutStatus     @default(NOT_ELIGIBLE)
  payoutTransactionId        String?
  platformMargin             Decimal?         @db.Decimal(10, 2)
  winningBidId               String?          @unique
  bids                       Bid[]            @relation("JobBids")
  driverDetails              DriverDetails?
  assignedOperator           OperatorProfile? @relation("AssignedOperator", fields: [assignedOperatorId], references: [id])
  assignedDriver             Driver?          @relation("AssignedDriver", fields: [assignedDriverId], references: [id])
  assignedVehicle            Vehicle?         @relation("AssignedVehicle", fields: [assignedVehicleId], references: [id])
  booking                    Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  winningBid                 Bid?             @relation("WinningBid", fields: [winningBidId], references: [id])

  @@index([status])
  @@index([assignedOperatorId])
  @@index([assignedDriverId])
  @@index([assignedVehicleId])
  @@index([biddingWindowClosesAt])
  @@index([acceptanceWindowClosesAt])
  @@index([payoutStatus])
  @@map("jobs")
}

model Bid {
  id          String          @id @default(cuid())
  jobId       String
  operatorId  String
  bidAmount   Decimal         @db.Decimal(10, 2)
  status      BidStatus       @default(PENDING)
  submittedAt DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  notes       String?
  offeredAt   DateTime?
  respondedAt DateTime?
  job         Job             @relation("JobBids", fields: [jobId], references: [id], onDelete: Cascade)
  operator    OperatorProfile @relation(fields: [operatorId], references: [id], onDelete: Cascade)
  wonJob      Job?            @relation("WinningBid")

  @@unique([jobId, operatorId])
  @@index([operatorId])
  @@index([status])
  @@map("bids")
}

model DriverDetails {
  id                  String   @id @default(cuid())
  driverName          String
  driverPhone         String
  vehicleRegistration String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  issuingCouncil      String?
  jobId               String   @unique
  taxiLicenceNumber   String?
  vehicleColor        String?
  vehicleMake         String?
  vehicleModel        String?
  job                 Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@map("driver_details")
}

model Transaction {
  id                    String            @id @default(cuid())
  bookingId             String
  transactionType       TransactionType
  amount                Decimal           @db.Decimal(10, 2)
  stripeTransactionId   String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  completedAt           DateTime?
  currency              String            @default("GBP")
  description           String?
  metadata              Json?
  stripePaymentIntentId String?
  status                TransactionStatus @default(PENDING)
  booking               Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([transactionType])
  @@index([status])
  @@map("transactions")
}

model PricingRule {
  id          String       @id @default(cuid())
  ruleType    String
  vehicleType VehicleType?
  baseValue   Decimal      @db.Decimal(10, 2)
  description String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  airportCode String?
  endDate     DateTime?
  endTime     String?
  percentage  Decimal?     @db.Decimal(5, 2)
  startDate   DateTime?
  startTime   String?

  @@index([ruleType])
  @@index([isActive])
  @@map("pricing_rules")
}

model Notification {
  id             String             @id @default(cuid())
  userId         String
  subject        String
  message        String
  status         NotificationStatus @default(PENDING)
  sentAt         DateTime?
  createdAt      DateTime           @default(now())
  errorMessage   String?
  failedAt       DateTime?
  metadata       Json?
  recipientEmail String?
  recipientPhone String?
  templateId     String?
  type           NotificationType   @default(EMAIL)
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("notifications")
}

model SystemSetting {
  id          String   @id @default(cuid())
  category    String
  key         String   @unique
  value       String
  dataType    String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([isActive])
  @@map("system_settings")
}

model VehicleCapacity {
  id                       String      @id @default(cuid())
  vehicleType              VehicleType @unique
  maxPassengers            Int
  maxPassengersHandOnly    Int?
  maxSuitcases             Int
  maxHandLuggage           Int         @default(2)
  rateReductionPer100Miles Decimal?    @db.Decimal(5, 2)
  exampleModels            String
  description              String?
  isActive                 Boolean     @default(true)
  createdAt                DateTime    @default(now())
  updatedAt                DateTime    @updatedAt

  @@map("vehicle_capacities")
}

model OtpToken {
  id        String   @id @default(cuid())
  userId    String
  email     String
  otp       String
  type      OtpType
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, type])
  @@index([expiresAt])
  @@map("otp_tokens")
}

enum UserRole {
  CUSTOMER
  OPERATOR
  ADMIN
}

enum BookingStatus {
  PENDING_PAYMENT
  PAID
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  REFUNDED
  NO_SHOW
}

enum JobStatus {
  OPEN_FOR_BIDDING
  BIDDING_CLOSED
  NO_BIDS_RECEIVED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  PENDING_ACCEPTANCE
}

enum BidStatus {
  PENDING
  WON
  LOST
  WITHDRAWN
  OFFERED
  ACCEPTED
  DECLINED
}

enum VehicleType {
  SALOON
  ESTATE
  MPV
  EXECUTIVE
  MINIBUS
  EXECUTIVE_LUXURY
  EXECUTIVE_PEOPLE_CARRIER
  GREEN_CAR
}

enum ServiceType {
  AIRPORT_PICKUP
  AIRPORT_DROPOFF
  POINT_TO_POINT
}

enum JourneyType {
  ONE_WAY
  OUTBOUND
  RETURN
}

enum BookingGroupStatus {
  ACTIVE
  PARTIALLY_CANCELLED
  FULLY_CANCELLED
  COMPLETED
}

enum DiscountType {
  RETURN_JOURNEY
  PROMOTIONAL
}

enum TransactionType {
  CUSTOMER_PAYMENT
  OPERATOR_PAYOUT
  REFUND
  PLATFORM_COMMISSION
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum PayoutStatus {
  NOT_ELIGIBLE
  PENDING
  PROCESSING
  COMPLETED
}

enum DocumentType {
  OPERATING_LICENSE
  INSURANCE
  OTHER
}

enum NotificationStatus {
  SENT
  FAILED
  BOUNCED
  PENDING
}

enum NotificationType {
  EMAIL
  SMS
}

enum OperatorApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum OtpType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
}
